<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Manajemen Pemeliharaan & Anggaran</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/lucide-react.js"></script>
    <!-- Custom Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .sidebar-item {
            transition: all 0.2s ease;
        }
        .sidebar-item.active, .sidebar-item:hover {
            background-color: #1e40af; /* a darker blue */
            color: white;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
            display: none; /* Hidden by default */
        }
        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar Navigation -->
    <aside class="w-64 bg-blue-800 text-white flex flex-col">
        <div class="p-6 text-2xl font-bold border-b border-blue-700">
            MANAJEMEN ASET
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" id="nav-dashboard" class="sidebar-item flex items-center p-3 rounded-lg active">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                Dashboard
            </a>
            <a href="#" id="nav-anggaran" class="sidebar-item flex items-center p-3 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
                Manajemen Anggaran
            </a>
            <a href="#" id="nav-pemeliharaan" class="sidebar-item flex items-center p-3 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                Rencana Pemeliharaan
            </a>
            <a href="#" id="nav-laporan" class="sidebar-item flex items-center p-3 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
                Laporan & Analitik
            </a>
            <a href="#" id="nav-audit" class="sidebar-item flex items-center p-3 rounded-lg">
                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-3"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/><path d="M5 19.5A9 9 0 0 0 12 22a9 9 0 0 0 7-2.5"/></svg>
                Riwayat & Audit
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white p-4 shadow-md flex justify-between items-center z-10">
            <h1 id="page-title" class="text-2xl font-semibold text-gray-800">Dashboard</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="role-switcher" class="text-sm font-medium">Login sebagai:</label>
                    <select id="role-switcher" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                        <option value="pemeliharaan">Pemeliharaan</option>
                        <option value="kasubag">Kasubag</option>
                        <option value="keuangan">Keuangan</option>
                    </select>
                </div>
                <div class="relative">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-gray-500"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                    </span>
                </div>
                 <div class="flex items-center space-x-2">
                    <img src="https://placehold.co/40x40/E2E8F0/4A5568?text=U" alt="User Avatar" class="w-10 h-10 rounded-full">
                    <div>
                        <p id="user-name" class="font-semibold text-sm">Staff Pemeliharaan</p>
                        <p id="user-role" class="text-xs text-gray-500">Pemeliharaan</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content Area -->
        <div class="flex-1 p-6 overflow-y-auto">
            
            <!-- Dashboard Page -->
            <div id="page-dashboard">
                <!-- Stat Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="card p-6 flex items-center space-x-4">
                         <div class="bg-blue-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-600"><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                        <div>
                            <p class="text-sm text-gray-500">Total Anggaran</p>
                            <p id="total-anggaran" class="text-2xl font-bold text-gray-800">Rp 0</p>
                        </div>
                    </div>
                    <div class="card p-6 flex items-center space-x-4">
                        <div class="bg-green-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                        <div>
                            <p class="text-sm text-gray-500">Realisasi Anggaran</p>
                            <p id="realisasi-anggaran" class="text-2xl font-bold text-gray-800">Rp 0</p>
                        </div>
                    </div>
                    <div class="card p-6 flex items-center space-x-4">
                        <div class="bg-yellow-100 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-600"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg></div>
                        <div>
                            <p class="text-sm text-gray-500">Sisa Anggaran</p>
                            <p id="sisa-anggaran" class="text-2xl font-bold text-gray-800">Rp 0</p>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 card p-6">
                        <h3 class="text-lg font-semibold mb-4">Grafik Penggunaan Biaya per Kategori</h3>
                        <canvas id="category-chart"></canvas>
                    </div>
                    <div class="lg:col-span-2 card p-6">
                        <h3 class="text-lg font-semibold mb-4">Reminder & Notifikasi</h3>
                        <div id="reminder-list" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- Reminder items will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manajemen Anggaran Page -->
            <div id="page-anggaran" class="hidden">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Input Data Anggaran</h3>
                    <form id="anggaran-form" class="space-y-4">
                        <div>
                            <label for="input-anggaran-awal" class="block text-sm font-medium text-gray-700">Anggaran Awal</label>
                            <input type="number" id="input-anggaran-awal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Contoh: 500000000">
                        </div>
                        <div>
                            <label for="input-realisasi" class="block text-sm font-medium text-gray-700">Realisasi Anggaran</label>
                            <input type="number" id="input-realisasi" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Contoh: 125000000">
                        </div>
                        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">Simpan Data Anggaran</button>
                    </form>
                    <p id="anggaran-access-message" class="hidden mt-4 text-sm text-red-600">Anda tidak memiliki akses untuk mengubah data ini. Hanya bagian Keuangan.</p>
                </div>
            </div>

            <!-- Rencana Pemeliharaan Page -->
            <div id="page-pemeliharaan" class="hidden">
                 <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Daftar Rencana Pemeliharaan</h3>
                        <button id="btn-tambah-pemeliharaan" class="inline-flex items-center justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Ajukan Rencana Baru
                        </button>
                    </div>
                     <p id="pemeliharaan-access-message" class="hidden mb-4 text-sm text-red-600">Anda tidak memiliki akses untuk mengajukan rencana. Hanya bagian Pemeliharaan.</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bulan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Pemeliharaan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Biaya</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pemeliharaan-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Laporan & Analitik Page -->
            <div id="page-laporan" class="hidden">
                 <div class="card p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Laporan & Analitik</h3>
                        <div>
                             <button class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">Ekspor Excel</button>
                             <button class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm">Ekspor PDF</button>
                        </div>
                    </div>
                    <p id="laporan-access-message" class="hidden mb-4 text-sm text-red-600">Hanya bagian Keuangan yang dapat mengakses halaman ini.</p>
                    <div id="laporan-content">
                        <h4 class="text-lg font-semibold mb-4">Tren Biaya Pemeliharaan Bulanan (Realisasi)</h4>
                        <canvas id="trend-chart" height="100"></canvas>
                    </div>
                 </div>
            </div>

             <!-- Audit Trail Page -->
            <div id="page-audit" class="hidden">
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Riwayat Aktivitas & Audit Trail</h3>
                     <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pengguna</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="audit-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for adding/editing maintenance plan -->
    <div id="pemeliharaan-modal-backdrop" class="modal-backdrop"></div>
    <div id="pemeliharaan-modal" class="modal-content card w-11/12 max-w-2xl p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Form Rencana Pemeliharaan</h2>
            <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
        </div>
        <form id="pemeliharaan-form" class="space-y-4">
            <div>
                <label for="bulan-pelaksanaan" class="block text-sm font-medium text-gray-700">Bulan Pelaksanaan</label>
                <select id="bulan-pelaksanaan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option>Januari</option>
                    <option>Februari</option>
                    <option>Maret</option>
                    <option>April</option>
                    <option>Mei</option>
                    <option>Juni</option>
                    <option>Juli</option>
                    <option>Agustus</option>
                    <option>September</option>
                    <option>Oktober</option>
                    <option>November</option>
                    <option>Desember</option>
                </select>
            </div>
            <div>
                <label for="kategori-pemeliharaan" class="block text-sm font-medium text-gray-700">Kategori</label>
                <select id="kategori-pemeliharaan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></select>
            </div>
             <div>
                <label for="jenis-pemeliharaan" class="block text-sm font-medium text-gray-700">Jenis</label>
                <select id="jenis-pemeliharaan" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option>Preventif</option>
                    <option>Reaktif</option>
                    <option>Operasional</option>
                    <option>Tak Terduga</option>
                </select>
            </div>
            <div>
                <label for="keterangan" class="block text-sm font-medium text-gray-700">Keterangan Detail</label>
                <textarea id="keterangan" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea>
            </div>
            <div>
                <label for="rincian-biaya" class="block text-sm font-medium text-gray-700">Rincian Biaya (Rp)</label>
                <input type="number" id="rincian-biaya" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="flex justify-end pt-4">
                <button type="button" id="cancel-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md mr-2 hover:bg-gray-300">Batal</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Ajukan</button>
            </div>
        </form>
    </div>

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300">
        <p>Notifikasi berhasil!</p>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- DATA MANAGEMENT ---
    // Data tidak lagi di-hardcode di sini. Kita akan mengambilnya dari server.
    let MOCK_DATA = {
        budget: {},
        kategori: {},
        pemeliharaan: [],
        auditLog: []
    };
    const API_URL = 'http://localhost:3000/api';

    let currentUserRole = 'pemeliharaan'; // Default role

    // --- DOM ELEMENTS ---
    const pages = {
        dashboard: document.getElementById('page-dashboard'),
        anggaran: document.getElementById('page-anggaran'),
        pemeliharaan: document.getElementById('page-pemeliharaan'),
        laporan: document.getElementById('page-laporan'),
        audit: document.getElementById('page-audit'),
    };
    const navLinks = {
        dashboard: document.getElementById('nav-dashboard'),
        anggaran: document.getElementById('nav-anggaran'),
        pemeliharaan: document.getElementById('nav-pemeliharaan'),
        laporan: document.getElementById('nav-laporan'),
        audit: document.getElementById('nav-audit'),
    };
    const pageTitle = document.getElementById('page-title');
    const roleSwitcher = document.getElementById('role-switcher');
    
    // Chart instances
    let categoryChart, trendChart;

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    
    const showToast = (message, isSuccess = true) => {
        const toast = document.getElementById('notification-toast');
        toast.querySelector('p').textContent = message;
        toast.classList.toggle('bg-green-500', isSuccess);
        toast.classList.toggle('bg-red-500', !isSuccess);
        toast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
    };

    const addAuditLog = (action) => {
        // Fungsi ini sekarang dikelola oleh server, 
        // namun bisa kita panggil secara optimis di client jika perlu.
        const userMap = {
            pemeliharaan: "Staff Pemeliharaan",
            kasubag: "Kasubag",
            keuangan: "Staff Keuangan",
        }
        MOCK_DATA.auditLog.unshift({
            time: new Date().toLocaleString('id-ID'),
            user: userMap[currentUserRole],
            action: action,
        });
        renderAuditLog();
    }
    
    // --- PAGE SWITCHING LOGIC ---
    const showPage = (pageKey) => {
        // Hide all pages
        Object.values(pages).forEach(page => page.classList.add('hidden'));
        // Show the active page
        pages[pageKey].classList.remove('hidden');
        // Update nav link styles
        Object.values(navLinks).forEach(link => link.classList.remove('active'));
        navLinks[pageKey].classList.add('active');
        // Update page title
        pageTitle.textContent = navLinks[pageKey].textContent.trim();
    };

    Object.keys(navLinks).forEach(key => {
        navLinks[key].addEventListener('click', (e) => {
            e.preventDefault();
            showPage(key);
        });
    });

    // --- RENDER FUNCTIONS ---
    // (Fungsi render lainnya ada di sini... diasumsikan tidak ada error)


    // Event listener untuk form pengajuan rencana pemeliharaan
    document.getElementById('pemeliharaan-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPlanData = {
            bulan: document.getElementById('bulan-pelaksanaan').value,
            kategori: document.getElementById('kategori-pemeliharaan').value,
            jenis: document.getElementById('jenis-pemeliharaan').value,
            keterangan: document.getElementById('keterangan').value,
            biaya: parseFloat(document.getElementById('rincian-biaya').value),
        };

        try {
            const response = await fetch(`${API_URL}/pemeliharaan`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-user-role': currentUserRole // Mengirim role user untuk audit log
                },
                body: JSON.stringify(newPlanData)
            });

            if (!response.ok) {
                throw new Error('Gagal mengirim data ke server');
            }

            const savedPlan = await response.json();
            MOCK_DATA.pemeliharaan.unshift(savedPlan);
            
            // Optimistic update untuk audit log
            addAuditLog(`Mengajukan rencana pemeliharaan baru: "${savedPlan.keterangan}"`);

            renderPemeliharaanTable();
            renderDashboard(); // Update reminders
            closeModal();
            showToast('Rencana pemeliharaan berhasil diajukan.');

        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal mengajukan rencana. Cek konsol.', false);
        }
    });

    // Event delegation for approve/reject buttons
    document.getElementById('pemeliharaan-table-body').addEventListener('click', async (e) => {
        const target = e.target;
        const planId = parseInt(target.dataset.id);
        let action = null;

        if (target.classList.contains('approve-btn')) {
            action = 'approve';
        } else if (target.classList.contains('reject-btn')) {
            action = 'reject';
        }

        if (!action || !planId) return;
        
        try {
            const response = await fetch(`${API_URL}/pemeliharaan/${planId}/${action}`, {
                method: 'PUT',
                 headers: {
                    'x-user-role': currentUserRole // Mengirim role user untuk audit log
                },
            });

            if (!response.ok) {
                throw new Error(`Gagal ${action} rencana`);
            }
            
            // Setelah berhasil, kita fetch ulang semua data untuk sinkronisasi
            await init();
            showToast(`Rencana berhasil di-${action === 'approve' ? 'setujui' : 'tolak'}.`);

        } catch (error) {
            console.error('Error:', error);
            showToast('Gagal memproses aksi. Cek konsol.', false);
        }
    });

    // --- INITIALIZATION ---
    const init = async () => {
        try {
            const response = await fetch(`${API_URL}/data`);
            if (!response.ok) {
                throw new Error('Tidak bisa terhubung ke server. Pastikan server sudah berjalan.');
            }
            MOCK_DATA = await response.json();
            
            showPage('dashboard');
            // Mock functions that need to be defined
            const updateUIForRole = () => {};
            const renderDashboard = () => {};
            const renderPemeliharaanTable = () => {};
            const renderLaporan = () => {};
            const renderAuditLog = () => {};
            const closeModal = () => {};
            
            updateUIForRole();
            renderDashboard();
            renderPemeliharaanTable();
            renderLaporan();
            renderAuditLog();

        } catch(error) {
            console.error(error);
            document.body.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-red-100 text-red-700 p-8">
                <p class="text-xl text-center">${error.message}<br>Jalankan 'npm start' pada direktori server.</p>
            </div>`;
        }
    };

    init();
});
</script>

</body>
</html>

